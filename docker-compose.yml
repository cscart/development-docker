version: "3.9"
services:
  mysql:
    image: mysql:5.7
    environment:
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
    volumes:
      - ./app/db:/var/lib/mysql
    ports:
      - "${MYSQL_LOCALHOST_PORT}:3306"
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-p$MYSQL_ROOT_PASSWORD"]
      timeout: 20s
      retries: 10
  nginx:
    image: nginx:alpine
    volumes:
      - ./app:/app
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "${CSCART_PORT}:80"
    depends_on:
      - php7.4
  php7.4:
    build:
      context: docker/php
      dockerfile: 7.4/Dockerfile
    env_file:
      - .env
    volumes:
      - ./app:/app
    environment:
      CSCART_INSTALL: "${CSCART_INSTALL}"
      PHP_IDE_CONFIG: "serverName=php7.4.cs-cart.local"
    depends_on:
      mysql:
        condition: service_healthy